// OrderFlow - Restaurant Online Ordering SaaS
// Production Database Schema - Feature Parity Edition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT (Restaurant/Location)
// ============================================
model Tenant {
  id                    String    @id @default(cuid())
  slug                  String    @unique
  name                  String
  email                 String    @unique
  phone                 String?
  
  // Multi-location support
  parentTenantId        String?   // If this is a child location
  parentTenant          Tenant?   @relation("TenantLocations", fields: [parentTenantId], references: [id])
  childLocations        Tenant[]  @relation("TenantLocations")
  
  // Location
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  latitude              Float?
  longitude             Float?
  timezone              String    @default("America/New_York")
  
  // Branding
  logo                  String?
  template              String    @default("modern")
  menuLayout            String    @default("blu-bentonville")
  primaryColor          String    @default("#2563eb")
  secondaryColor        String    @default("#1e40af")
  
  // Stripe Connect
  stripeAccountId       String?
  stripeOnboardingComplete Boolean @default(false)
  
  // Core Settings
  pickupEnabled         Boolean   @default(true)
  deliveryEnabled       Boolean   @default(false)
  scheduledOrdersEnabled Boolean  @default(true)
  giftCardsEnabled      Boolean   @default(true)
  loyaltyEnabled        Boolean   @default(false)
  reviewsEnabled        Boolean   @default(true)
  
  // Fees
  taxRate               Float     @default(0)
  deliveryFee           Float     @default(0)
  minOrderAmount        Float     @default(0)
  platformFeePercent    Float     @default(2.9)
  
  // Order Throttling
  maxOrdersPerWindow    Int?      // e.g., 10
  orderWindowMinutes    Int?      // e.g., 15 (so 10 orders per 15 min)
  
  // Hours
  businessHours         Json?
  
  // DoorDash
  doordashDeveloperId   String?
  doordashKeyId         String?
  doordashSigningSecret String?
  pickupInstructions    String?
  
  // Twilio (SMS)
  twilioAccountSid      String?
  twilioAuthToken       String?
  twilioPhoneNumber     String?
  smsNotificationsEnabled Boolean @default(false)
  
  // Loyalty Settings
  loyaltyPointsPerDollar Int      @default(1)
  loyaltyPointsRedemptionRate Int @default(100) // 100 points = $5
  loyaltyRedemptionValue Float   @default(5)
  
  // Status
  isActive              Boolean   @default(true)
  isOnboarded           Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  users                 User[]
  categories            Category[]
  menuItems             MenuItem[]
  modifierGroups        ModifierGroup[]
  orders                Order[]
  giftCards             GiftCard[]
  promoCodes            PromoCode[]
  customers             Customer[]
  reviews               Review[]
  abandonedCarts        AbandonedCart[]
  
  @@index([slug])
  @@index([email])
  @@index([parentTenantId])
}

// ============================================
// USER (Restaurant Staff)
// ============================================
model User {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email         String
  passwordHash  String
  name          String?
  role          String    @default("owner") // owner, manager, staff
  
  // Permissions (for staff role)
  canViewOrders     Boolean @default(true)
  canEditOrders     Boolean @default(false)
  canEditMenu       Boolean @default(false)
  canEditSettings   Boolean @default(false)
  canViewAnalytics  Boolean @default(false)
  canManageStaff    Boolean @default(false)
  
  // Password reset
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Email verification
  emailVerified     Boolean   @default(false)
  verifyToken       String?
  
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([tenantId, email])
  @@index([email])
}

// ============================================
// CUSTOMER (End User Account)
// ============================================
model Customer {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  phone         String    // Primary identifier
  email         String?
  name          String?
  
  // Loyalty
  loyaltyPoints Int       @default(0)
  totalSpent    Float     @default(0)
  orderCount    Int       @default(0)
  
  // Phone verification
  phoneVerified Boolean   @default(false)
  verifyCode    String?
  verifyCodeExpiry DateTime?
  
  // Favorites (item IDs)
  favoriteItems String[]  @default([])
  
  // Allergens to filter
  allergenFilters String[] @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  reviews       Review[]
  
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
}

// ============================================
// MENU CATEGORY
// ============================================
model Category {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  image       String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  
  // Scheduling (null = always show)
  availableFrom String?  // "06:00" 
  availableTo   String?  // "11:00"
  availableDays String[] @default([]) // ["monday", "tuesday", ...] empty = all days
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  menuItems   MenuItem[]
  
  @@index([tenantId])
  @@index([tenantId, sortOrder])
}

// ============================================
// MENU ITEM
// ============================================
model MenuItem {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  price       Float
  image       String?
  
  // Variants (e.g., Small/Medium/Large as primary selector)
  variants    Json?     // [{ name: "Small", price: 12.99 }, { name: "Large", price: 16.99 }]
  
  // Linked modifier groups
  modifierGroupIds String[] @default([])
  
  // 86'd / Sold Out
  isSoldOut   Boolean   @default(false)
  soldOutAutoReset Boolean @default(true) // Reset at midnight
  
  // Prep time in minutes
  prepTimeMinutes Int?
  
  // Availability
  isAvailable Boolean   @default(true)
  sortOrder   Int       @default(0)
  
  // Scheduling
  availableFrom String?
  availableTo   String?
  availableDays String[] @default([])
  
  // Allergens
  allergens   String[]  @default([]) // ["nuts", "dairy", "gluten", "shellfish", "eggs", "soy"]
  
  // Nutrition
  calories    Int?
  
  // Upsell prompt
  upsellItemId String?   // "Add fries for $2?"
  upsellPrice  Float?
  
  // Bundle/Combo
  isCombo         Boolean @default(false)
  comboComponents Json?   // [{ categoryId, itemCount, label: "Choose your side" }]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([categoryId])
  @@index([tenantId, isAvailable])
}

// ============================================
// MODIFIER GROUP
// ============================================
model ModifierGroup {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String    // "Toppings", "Sides", "Sauce"
  description String?
  
  // Selection rules
  isRequired  Boolean   @default(false)
  minSelections Int     @default(0)  // "Choose at least 2"
  maxSelections Int?    // "Choose up to 3" (null = unlimited)
  
  // Modifiers
  modifiers   Json      // [{ name: "Pepperoni", price: 1.50 }, ...]
  
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId])
}

// ============================================
// ORDER
// ============================================
model Order {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Customer (optional link)
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  orderNumber     String
  status          String    @default("pending")
  type            String    // pickup, delivery
  
  // Customer info
  customerName    String
  customerEmail   String
  customerPhone   String
  
  // Delivery
  deliveryAddress String?
  deliveryLat     Float?
  deliveryLng     Float?
  
  // Items
  items           Json
  
  // Pricing
  subtotal        Float
  tax             Float
  tip             Float     @default(0)
  deliveryFee     Float     @default(0)
  discount        Float     @default(0)
  total           Float
  
  // Promo code used
  promoCodeId     String?
  promoCodeDiscount Float   @default(0)
  
  // Payment
  paymentIntentId String?
  paymentStatus   String    @default("pending")
  
  // Refund
  refundedAmount  Float     @default(0)
  refundReason    String?
  refundedAt      DateTime?
  
  // Gift card
  giftCardId      String?
  giftCardAmount  Float     @default(0)
  
  // Loyalty points earned/redeemed
  loyaltyPointsEarned   Int @default(0)
  loyaltyPointsRedeemed Int @default(0)
  
  // Scheduling
  scheduledFor    DateTime?
  scheduledDate   String?   // "2024-01-15" for future date orders
  estimatedReady  DateTime?
  
  // Prep time (calculated from items)
  estimatedPrepMinutes Int?
  
  // Notes
  notes           String?   // Customer notes
  kitchenNotes    String?   // Internal staff notes
  
  // DoorDash
  doordashDeliveryId String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([orderNumber])
  @@index([customerId])
  @@index([paymentIntentId])
}

// ============================================
// PROMO CODE
// ============================================
model PromoCode {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  code        String    // "FIRST10", "SUMMER20"
  description String?
  
  // Discount type
  discountType    String  // "percent" | "fixed"
  discountValue   Float   // 10 (for 10%) or 5.00 (for $5 off)
  
  // Rules
  minOrderAmount  Float?
  maxDiscountAmount Float? // Cap for percent discounts
  firstTimeOnly   Boolean @default(false)
  singleUse       Boolean @default(false)
  
  // Usage tracking
  usageCount      Int     @default(0)
  maxUsageCount   Int?    // null = unlimited
  
  // Validity
  startsAt        DateTime?
  expiresAt       DateTime?
  isActive        Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
}

// ============================================
// REVIEW
// ============================================
model Review {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  orderId     String?
  rating      Int       // 1-5
  comment     String?
  
  // Restaurant response
  response    String?
  respondedAt DateTime?
  
  isPublic    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, rating])
}

// ============================================
// ABANDONED CART
// ============================================
model AbandonedCart {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Customer info (captured early)
  email       String?
  phone       String?
  
  // Cart contents
  items       Json
  subtotal    Float
  
  // Recovery status
  recoveryEmailSent Boolean   @default(false)
  recoverySmsSent   Boolean   @default(false)
  recovered         Boolean   @default(false)
  recoveredOrderId  String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, createdAt])
}

// ============================================
// PROCESSED WEBHOOK (Idempotency)
// ============================================
model ProcessedWebhook {
  id          String    @id @default(cuid())
  eventId     String    @unique
  source      String
  eventType   String
  processedAt DateTime  @default(now())
  
  @@index([eventId])
  @@index([source, processedAt])
}

// ============================================
// GIFT CARD
// ============================================
model GiftCard {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  code            String    @unique
  initialBalance  Float
  currentBalance  Float
  
  purchaserName   String?
  purchaserEmail  String?
  recipientName   String?
  recipientEmail  String?
  message         String?
  
  isActive        Boolean   @default(true)
  expiresAt       DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([code])
}

// ============================================
// SESSION
// ============================================
model Session {
  id          String    @id @default(cuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  
  @@index([token])
  @@index([userId])
}
